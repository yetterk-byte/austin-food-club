<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Austin Food Club - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            min-height: 100vh;
        }
        
        .admin-dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-right: 1px solid #333;
            padding: 2rem;
        }
        
        .sidebar h1 {
            font-family: 'Monoton', cursive;
            color: #20b2aa;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }
        
        .sidebar p {
            color: #888;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }
        
        .nav-item {
            display: block;
            padding: 1rem;
            color: #ccc;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(32, 178, 170, 0.1);
            color: #20b2aa;
        }
        
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
        }
        
        .dashboard-header {
            margin-bottom: 2rem;
        }
        
        .dashboard-header h2 {
            font-size: 2.5rem;
            color: #20b2aa;
            margin-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .stat-card h3 {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #20b2aa;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .change {
            font-size: 0.8rem;
            color: #888;
        }
        
        .section {
            background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .section h3 {
            color: #20b2aa;
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }
        
        .current-restaurant {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .restaurant-image {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .restaurant-info h4 {
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .restaurant-info p {
            color: #888;
            margin-bottom: 0.5rem;
        }
        
        .btn {
            background: #20b2aa;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s ease;
            margin-right: 1rem;
        }
        
        .btn:hover {
            background: #1a9d96;
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid #20b2aa;
            color: #20b2aa;
        }
        
        .btn-secondary:hover {
            background: rgba(32, 178, 170, 0.1);
        }
        
        .rotation-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .mode-toggle {
            background: rgba(32, 178, 170, 0.1);
            border: 1px solid rgba(32, 178, 170, 0.3);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: #20b2aa;
            cursor: pointer;
        }
        
        .mode-toggle.active {
            background: #20b2aa;
            color: white;
        }
        
        .queue-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .queue-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .queue-item h4 {
            color: white;
            margin-bottom: 0.25rem;
        }
        
        .queue-item p {
            color: #888;
            font-size: 0.9rem;
        }
        
        .featured-restaurant {
            background: linear-gradient(135deg, #2d4a22 0%, #3d5a32 100%);
            border: 2px solid #20b2aa;
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .featured-restaurant .restaurant-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .featured-restaurant .restaurant-info h4 {
            color: #20b2aa;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .featured-restaurant .restaurant-info p {
            color: #ccc;
            margin-bottom: 0.25rem;
        }
        
        .featured-badge {
            background: #20b2aa;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: auto;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .search-result-item {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s ease;
        }
        
        .search-result-item:hover {
            border-color: #20b2aa;
        }
        
        .search-result-info h4 {
            color: white;
            margin-bottom: 0.25rem;
        }
        
        .search-result-info p {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .search-result-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.8rem;
        }
        
        .rating-stars {
            color: #ffd700;
        }
        
        .price-range {
            color: #28a745;
            font-weight: bold;
        }
        
        .review-count {
            color: #888;
        }
        
        /* Drag and Drop Styles */
        .queue-item {
            cursor: move;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .queue-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(32, 178, 170, 0.2);
        }
        
        .queue-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            z-index: 1000;
        }
        
        .queue-item.drag-over {
            border-color: #20b2aa !important;
            background: #1a3a3a !important;
        }
        
        .drag-handle {
            color: #888;
            cursor: grab;
            margin-right: 0.75rem;
            font-size: 1.2rem;
            user-select: none;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .queue-position {
            background: #20b2aa;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
            margin-right: 0.75rem;
            min-width: 2rem;
            text-align: center;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
            min-width: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #20b2aa;
        }
        
        .error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #dc3545;
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .success {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 8px;
            padding: 1rem;
            color: #28a745;
            text-align: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="admin-dashboard">
        <div class="sidebar">
            <h1>Austin Food Club</h1>
            <p>Admin Dashboard</p>
            
            <button class="nav-item active" onclick="showSection('overview')">📊 Overview</button>
            <button class="nav-item" onclick="showSection('queue')">🍽️ Restaurant Queue</button>
            <button class="nav-item" onclick="showSection('rotation')">🔄 Rotation System</button>
            <button class="nav-item" onclick="showSection('current')">⭐ Current Week</button>
            <button class="nav-item" onclick="showSection('analytics')">📈 Analytics</button>
            
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #333;">
                <button class="nav-item" onclick="logout()" style="color: #dc3545;">
                    🚪 Logout
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <div id="messageContainer"></div>
            
            <!-- Overview Section -->
            <div id="overview" class="section-content">
                <div class="dashboard-header">
                    <h2>Admin Dashboard</h2>
                    <p>Manage your Austin Food Club community</p>
                </div>
                
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="totalUsers">-</div>
                        <div class="change">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Week's RSVPs</h3>
                        <div class="value" id="thisWeekRSVPs">-</div>
                        <div class="change">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Restaurants</h3>
                        <div class="value" id="totalRestaurants">-</div>
                        <div class="change">Loading...</div>
                    </div>
                    <div class="stat-card">
                        <h3>Queue Length</h3>
                        <div class="value" id="queueLength">-</div>
                        <div class="change">Loading...</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Current Featured Restaurant</h3>
                    <div id="currentRestaurant">
                        <div class="loading">Loading current restaurant...</div>
                    </div>
                </div>
            </div>
            
            <!-- Queue Section -->
            <div id="queue" class="section-content" style="display: none;">
                <div class="dashboard-header">
                    <h2>Restaurant Queue</h2>
                    <p>Manage upcoming featured restaurants</p>
                </div>
                
                <div class="section">
                    <h3>Currently Featured Restaurant</h3>
                    <div id="currentlyFeatured">
                        <div class="loading">Loading current restaurant...</div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Add Restaurant to Queue</h3>
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                        <input type="text" id="restaurantSearch" placeholder="Search Austin restaurants..." 
                               style="flex: 1; padding: 0.75rem; border: 1px solid #444; border-radius: 6px; background: #2a2a2a; color: white;">
                        <button class="btn" onclick="searchRestaurants()">🔍 Search Yelp</button>
                        <button class="btn btn-secondary" onclick="refreshQueue()">🔄 Refresh Queue</button>
                        <button class="btn btn-success" onclick="autoAddRestaurant()">🎯 Auto-Discover Restaurant</button>
                    </div>
                    
                    <div id="searchResults" style="margin-bottom: 1rem;"></div>
                </div>
                
                <div class="section">
                    <h3>Restaurant Queue</h3>
                    <div class="queue-list" id="queueList">
                        <div class="loading">Loading queue...</div>
                    </div>
                </div>
            </div>
            
            <!-- Rotation Section -->
            <div id="rotation" class="section-content" style="display: none;">
                <div class="dashboard-header">
                    <h2>Rotation System</h2>
                    <p>Configure automatic restaurant rotation</p>
                </div>
                
                <div class="section">
                    <h3>Rotation Mode</h3>
                    <div class="rotation-controls">
                        <button class="mode-toggle" id="manualMode" onclick="setRotationMode('MANUAL')">Manual</button>
                        <button class="mode-toggle" id="automaticMode" onclick="setRotationMode('AUTOMATIC')">Automatic</button>
                    </div>
                    
                    <div id="rotationConfig">
                        <div class="loading">Loading rotation configuration...</div>
                    </div>
                </div>
            </div>
            
            <!-- Current Week Section -->
            <div id="current" class="section-content" style="display: none;">
                <div class="dashboard-header">
                    <h2>Current Week Management</h2>
                    <p>Override current restaurant and view stats</p>
                </div>
                
                <div class="section">
                    <h3>Current Featured Restaurant</h3>
                    <div id="currentFeaturedRestaurant">
                        <div class="loading">Loading current restaurant...</div>
                    </div>
                    <p style="color: #888; margin-top: 1rem;">
                        Restaurants rotate automatically every Tuesday at 9:00 AM. 
                        Use the queue management to control the order.
                    </p>
                    <button class="btn btn-warning" onclick="testRotationAndAutoQueue()" style="margin-top: 1rem;">
                        🧪 Test Rotation + Auto-Queue
                    </button>
                </div>
            </div>
            
            <!-- Analytics Section -->
            <div id="analytics" class="section-content" style="display: none;">
                <div class="dashboard-header">
                    <h2>Analytics</h2>
                    <p>View detailed insights and performance metrics</p>
                </div>
                
                <div class="section">
                    <h3>System Status</h3>
                    <div id="systemStatus">
                        <div class="loading">Loading system status...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminToken = localStorage.getItem('adminToken');
        let currentSection = 'overview';
        
        // Check if user is logged in
        if (!adminToken) {
            window.location.href = '/admin.html';
        }
        
        // API helper function
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`http://localhost:3001${endpoint}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin.html';
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'API request failed');
                }
                
                return response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).style.display = 'block';
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            currentSection = sectionName;
            
            // Load section data
            loadSectionData(sectionName);
        }
        
        // Load data for specific section
        async function loadSectionData(sectionName) {
            switch (sectionName) {
                case 'overview':
                    await loadDashboardStats();
                    await loadCurrentRestaurant();
                    break;
                case 'queue':
                    await loadCurrentlyFeatured();
                    await loadQueue();
                    break;
                case 'rotation':
                    await loadRotationConfig();
                    break;
                case 'analytics':
                    await loadSystemStatus();
                    break;
            }
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const data = await apiCall('/api/admin/dashboard');
                
                document.getElementById('totalUsers').textContent = data.stats.totalUsers;
                document.getElementById('thisWeekRSVPs').textContent = data.stats.thisWeekRSVPs;
                document.getElementById('totalRestaurants').textContent = data.stats.totalRestaurants;
                document.getElementById('queueLength').textContent = data.stats.queueLength;
                
                // Update change text
                document.querySelector('#totalUsers').nextElementSibling.textContent = `+${data.stats.newUsersThisWeek || 0} this week`;
                document.querySelector('#thisWeekRSVPs').nextElementSibling.textContent = 'Active RSVPs';
                document.querySelector('#totalRestaurants').nextElementSibling.textContent = 'In database';
                document.querySelector('#queueLength').nextElementSibling.textContent = 'Pending restaurants';
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showMessage('Failed to load dashboard statistics', 'error');
            }
        }
        
        // Load current restaurant
        async function loadCurrentRestaurant() {
            try {
                const data = await apiCall('/api/restaurants/current');
                
                const container = document.getElementById('currentRestaurant');
                container.innerHTML = `
                    <div class="current-restaurant">
                        <img src="${data.imageUrl || '/placeholder-restaurant.jpg'}" alt="${data.name}" class="restaurant-image">
                        <div class="restaurant-info">
                            <h4>${data.name}</h4>
                            <p>${data.address}</p>
                            <p>⭐ ${data.rating} • ${data.price} • ${data.expectedWait}</p>
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary" onclick="manualRotation()">Change Restaurant</button>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading current restaurant:', error);
                document.getElementById('currentRestaurant').innerHTML = '<div class="error">Failed to load current restaurant</div>';
            }
        }
        
        // Load currently featured restaurant for queue page
        async function loadCurrentlyFeatured() {
            try {
                const data = await apiCall('/api/restaurants/current');
                
                const container = document.getElementById('currentlyFeatured');
                container.innerHTML = `
                    <div class="featured-restaurant">
                        <img src="${data.imageUrl || '/placeholder-restaurant.jpg'}" alt="${data.name}" class="restaurant-image">
                        <div class="restaurant-info">
                            <h4>⭐ ${data.name}</h4>
                            <p>📍 ${data.address}</p>
                            <p>⭐ ${data.rating} • ${data.price} • ${data.expectedWait || 'N/A wait'}</p>
                            <p style="font-size: 0.9rem; color: #888;">This restaurant is currently featured to users</p>
                        </div>
                        <div class="featured-badge">LIVE NOW</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading currently featured restaurant:', error);
                document.getElementById('currentlyFeatured').innerHTML = '<div class="error">Failed to load current restaurant</div>';
            }
        }

        // Load queue
        async function loadQueue() {
            try {
                const data = await apiCall('/api/admin/queue');
                
                const container = document.getElementById('queueList');
                if (data.queue.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888; padding: 2rem;">Queue is empty. Add restaurants to start planning.</p>';
                } else {
                    container.innerHTML = data.queue.map((item, index) => `
                        <div class="queue-item" data-queue-id="${item.id}" data-position="${item.position}">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <span class="queue-position">${item.position}</span>
                                <div style="flex: 1;">
                                    <h4>${item.restaurant.name}</h4>
                                    <p>${item.restaurant.address}</p>
                                    <p>Added by ${item.admin.name} • ${item.notes || 'No notes'}</p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                ${index > 0 ? `<button class="btn btn-sm" onclick="moveQueueItem('${item.id}', ${item.position - 1})" title="Move Up">↑</button>` : ''}
                                ${index < data.queue.length - 1 ? `<button class="btn btn-sm" onclick="moveQueueItem('${item.id}', ${item.position + 1})" title="Move Down">↓</button>` : ''}
                                <button class="btn btn-secondary btn-sm" onclick="removeFromQueue('${item.id}')">Remove</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading queue:', error);
                document.getElementById('queueList').innerHTML = '<div class="error">Failed to load queue</div>';
            }
        }
        
        // Load rotation configuration
        async function loadRotationConfig() {
            try {
                const data = await apiCall('/api/rotation/config');
                
                // Update mode toggles
                document.getElementById('manualMode').classList.toggle('active', data.config.mode === 'MANUAL');
                document.getElementById('automaticMode').classList.toggle('active', data.config.mode === 'AUTOMATIC');
                
                const container = document.getElementById('rotationConfig');
                container.innerHTML = `
                    <div style="margin-top: 1rem;">
                        <p><strong>Current Mode:</strong> ${data.config.mode}</p>
                        <p><strong>Rotation Day:</strong> ${data.config.rotationDay}</p>
                        <p><strong>Rotation Time:</strong> ${data.config.rotationTime}</p>
                        <p><strong>Next Rotation:</strong> ${new Date(data.config.nextRotationDate).toLocaleDateString()}</p>
                        <p><strong>Active:</strong> ${data.config.isActive ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading rotation config:', error);
                document.getElementById('rotationConfig').innerHTML = '<div class="error">Failed to load rotation configuration</div>';
            }
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const data = await apiCall('/api/rotation/status');
                
                const container = document.getElementById('systemStatus');
                container.innerHTML = `
                    <div>
                        <h4>Rotation System</h4>
                        <p><strong>Mode:</strong> ${data.rotationConfig.mode}</p>
                        <p><strong>Queue Health:</strong> ${data.queueStats.queueHealth}</p>
                        <p><strong>Pending Restaurants:</strong> ${data.queueStats.totalPending}</p>
                        <p><strong>Jobs Running:</strong> ${data.isInitialized ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading system status:', error);
                document.getElementById('systemStatus').innerHTML = '<div class="error">Failed to load system status</div>';
            }
        }
        
        // Admin actions
        async function setRotationMode(mode) {
            try {
                await apiCall('/api/rotation/config', {
                    method: 'PUT',
                    body: JSON.stringify({ mode })
                });
                
                showMessage(`Rotation mode set to ${mode}`, 'success');
                loadRotationConfig();
            } catch (error) {
                showMessage(`Failed to set rotation mode: ${error.message}`, 'error');
            }
        }
        
        async function manualRotation() {
            if (!confirm('Are you sure you want to manually rotate to the next restaurant?')) {
                return;
            }
            
            try {
                const result = await apiCall('/api/rotation/manual', {
                    method: 'POST',
                    body: JSON.stringify({ notes: 'Manual rotation from admin dashboard' })
                });
                
                showMessage('Manual rotation completed successfully!', 'success');
                loadCurrentRestaurant();
                loadQueue();
            } catch (error) {
                showMessage(`Manual rotation failed: ${error.message}`, 'error');
            }
        }
        
        async function emergencyOverride() {
            const restaurantId = prompt('Enter restaurant ID for emergency override:');
            const reason = prompt('Enter reason for emergency override:');
            
            if (!restaurantId || !reason) {
                return;
            }
            
            try {
                await apiCall('/api/rotation/emergency', {
                    method: 'POST',
                    body: JSON.stringify({ restaurantId, reason })
                });
                
                showMessage('Emergency override completed!', 'success');
                loadCurrentRestaurant();
            } catch (error) {
                showMessage(`Emergency override failed: ${error.message}`, 'error');
            }
        }
        
        // Search restaurants using Yelp API
        async function searchRestaurants() {
            const searchTerm = document.getElementById('restaurantSearch').value.trim();
            if (!searchTerm) {
                showMessage('Please enter a restaurant name to search', 'error');
                return;
            }
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading">Searching Yelp for restaurants...</div>';
            
            try {
                const data = await apiCall(`/api/admin/restaurants/search-yelp?term=${encodeURIComponent(searchTerm)}&limit=5`);
                
                if (!data.restaurants || data.restaurants.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #888; padding: 1rem;">No restaurants found. Try a different search term.</p>';
                    return;
                }
                
                resultsContainer.innerHTML = `
                    <h4 style="color: #20b2aa; margin-bottom: 1rem;">Search Results (${data.restaurants.length})</h4>
                    <div class="search-results">
                        ${data.restaurants.map((restaurant, index) => {
                            // Store restaurant data in a global variable to avoid JSON escaping issues
                            window.searchResults = window.searchResults || {};
                            window.searchResults[restaurant.yelpId] = restaurant;
                            
                            return `
                            <div class="search-result-item" data-yelp-id="${restaurant.yelpId}">
                                <div class="search-result-info">
                                    <h4>${restaurant.name}</h4>
                                    <p>📍 ${restaurant.address}</p>
                                    <div class="search-result-meta">
                                        <span class="rating-stars">⭐ ${restaurant.rating || 'N/A'}</span>
                                        <span class="price-range">${restaurant.price || '$'}</span>
                                        <span class="review-count">${restaurant.reviewCount || 0} reviews</span>
                                        <span style="color: #20b2aa;">${restaurant.categories || 'Restaurant'}</span>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn" onclick="addRestaurantFromSearch(this)">
                                        + Add to Queue
                                    </button>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="error">Failed to search restaurants. Please try again.</div>';
            }
        }
        
        // Add restaurant from search results to queue (fixed approach)
        async function addRestaurantFromSearch(buttonElement) {
            try {
                // Get restaurant data from global storage (avoids JSON parsing issues)
                const searchItem = buttonElement.closest('.search-result-item');
                const yelpId = searchItem.getAttribute('data-yelp-id');
                const restaurantData = window.searchResults[yelpId];
                
                if (!restaurantData) {
                    throw new Error('Restaurant data not found. Please search again.');
                }
                
                console.log('Adding restaurant to queue:', restaurantData);
                
                const notes = prompt(`Add notes for ${restaurantData.name}:`) || `Added ${restaurantData.name} from Yelp search`;
                
                // Disable button to prevent double-clicks
                buttonElement.disabled = true;
                buttonElement.textContent = 'Adding...';
                
                const response = await apiCall('/api/admin/restaurants/quick-add', {
                    method: 'POST',
                    body: JSON.stringify({
                        yelpId: restaurantData.yelpId,
                        name: restaurantData.name,
                        address: restaurantData.address,
                        rating: restaurantData.rating,
                        price: restaurantData.price,
                        categories: restaurantData.categories,
                        imageUrl: restaurantData.imageUrl,
                        notes: notes
                    })
                });
                
                console.log('Add to queue response:', response);
                
                if (response.success) {
                    showMessage(`${restaurantData.name} added to queue at position ${response.position}!`, 'success');
                    
                    // Clear search results and refresh
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('restaurantSearch').value = '';
                    window.searchResults = {}; // Clear search data
                    await loadCurrentlyFeatured();
                    await loadQueue();
                    await loadDashboardStats();
                } else {
                    throw new Error(response.error || 'Failed to add restaurant');
                }
                
            } catch (error) {
                console.error('Add to queue error:', error);
                
                // Re-enable button
                buttonElement.disabled = false;
                buttonElement.textContent = '+ Add to Queue';
                
                if (error.message.includes('already in queue')) {
                    showMessage(`Restaurant is already in the queue!`, 'error');
                } else if (error.message.includes('currently featured')) {
                    showMessage(`Restaurant is currently featured and cannot be added to queue`, 'error');
                } else {
                    showMessage(`Failed to add restaurant: ${error.message}`, 'error');
                }
            }
        }
        
        // Add Enter key support for search
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Austin Food Club Admin Dashboard Loaded');
            loadSectionData('overview');
            
            // Add Enter key listener to search input
            setTimeout(() => {
                const searchInput = document.getElementById('restaurantSearch');
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            searchRestaurants();
                        }
                    });
                }
            }, 100);
        });
        
        async function removeFromQueue(queueId) {
            if (!confirm('Are you sure you want to remove this restaurant from the queue?')) {
                return;
            }
            
            try {
                await apiCall(`/api/admin/queue/${queueId}`, {
                    method: 'DELETE'
                });
                
                showMessage('Restaurant removed from queue', 'success');
                loadQueue();
                loadDashboardStats();
            } catch (error) {
                showMessage(`Failed to remove restaurant: ${error.message}`, 'error');
            }
        }
        
        async function refreshQueue() {
            await loadCurrentlyFeatured();
            await loadQueue();
            showMessage('Queue refreshed', 'success');
        }
        
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin.html';
        }
        
        // Drag and Drop Queue Reordering
        function addDragAndDropListeners() {
            const queueItems = document.querySelectorAll('.queue-item');
            
            queueItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const draggedId = draggedElement.getAttribute('data-queue-id');
                const draggedPosition = parseInt(draggedElement.getAttribute('data-position'));
                const targetPosition = parseInt(this.getAttribute('data-position'));
                
                console.log('Reordering:', { draggedId, draggedPosition, targetPosition });
                
                try {
                    // Get current queue to build new order array
                    const currentQueue = await apiCall('/api/admin/queue');
                    
                    // Create new order array by swapping positions
                    const newOrder = [];
                    
                    // First, create a copy of the queue with updated positions
                    const queueCopy = [...currentQueue.queue];
                    
                    // Find the dragged item and target item
                    const draggedItem = queueCopy.find(item => item.id === draggedId);
                    const targetItem = queueCopy.find(item => item.position === targetPosition);
                    
                    if (draggedItem && targetItem) {
                        // Swap positions
                        const tempPosition = draggedItem.position;
                        draggedItem.position = targetItem.position;
                        targetItem.position = tempPosition;
                        
                        // Build the new order array
                        queueCopy.forEach(item => {
                            newOrder.push({
                                id: item.id,
                                position: item.position
                            });
                        });
                        
                        // Call API to reorder with the expected format
                        await apiCall('/api/admin/queue/reorder', {
                            method: 'POST',
                            body: JSON.stringify({
                                newOrder: newOrder
                            })
                        });
                        
                        showMessage('Queue reordered successfully!', 'success');
                        await loadQueue(); // Refresh the queue
                        await loadDashboardStats(); // Update stats
                    }
                    
                } catch (error) {
                    console.error('Reorder error:', error);
                    showMessage('Failed to reorder queue: ' + error.message, 'error');
                }
            }
            
            this.classList.remove('drag-over');
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove drag-over class from all items
            document.querySelectorAll('.queue-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedElement = null;
        }
        
        // Move queue item up or down one position (simplified approach)
        async function moveQueueItem(queueItemId, newPosition) {
            try {
                console.log('Moving queue item:', queueItemId, 'to position:', newPosition);
                
                // Use the PUT endpoint to update individual queue item
                const response = await apiCall(`/api/admin/queue/${queueItemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        position: newPosition
                    })
                });
                
                showMessage(`Restaurant moved to position ${newPosition}!`, 'success');
                await loadQueue();
                await loadDashboardStats();
                
            } catch (error) {
                console.error('Move queue item error:', error);
                showMessage('Failed to move restaurant: ' + error.message, 'error');
            }
        }
        
        // Auto-discover and add restaurant to queue
        async function autoAddRestaurant() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '🔍 Discovering...';
                button.disabled = true;

                console.log('Auto-discovering restaurant...');

                const response = await apiCall('/api/admin/queue/auto-add', {
                    method: 'POST'
                });

                if (response.success) {
                    showMessage(`🎉 Auto-discovered: ${response.restaurant.name} added to queue at position ${response.queuePosition}!`, 'success');
                    await loadQueue();
                    await loadDashboardStats();
                } else {
                    showMessage('Failed to auto-discover restaurant', 'error');
                }

            } catch (error) {
                console.error('Auto-discover error:', error);
                showMessage('Failed to auto-discover restaurant: ' + error.message, 'error');
            } finally {
                const button = event.target;
                button.textContent = '🎯 Auto-Discover Restaurant';
                button.disabled = false;
            }
        }

        // Test rotation and auto-queue functionality
        async function testRotationAndAutoQueue() {
            try {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '🔄 Rotating...';
                button.disabled = true;

                console.log('Testing rotation + auto-queue...');

                const response = await apiCall('/api/admin/rotation/trigger', {
                    method: 'POST'
                });

                if (response.success) {
                    showMessage(`🎉 Rotation complete! ${response.newRestaurant} is now featured. New restaurant auto-added to queue!`, 'success');
                    await loadQueue();
                    await loadDashboardStats();
                    // Refresh current featured restaurant if that section exists
                    if (document.getElementById('currentFeaturedRestaurant')) {
                        loadCurrentFeaturedRestaurant();
                    }
                } else {
                    showMessage('Failed to trigger rotation: ' + response.error, 'error');
                }

            } catch (error) {
                console.error('Rotation test error:', error);
                showMessage('Failed to trigger rotation: ' + error.message, 'error');
            } finally {
                const button = event.target;
                button.textContent = '🧪 Test Rotation + Auto-Queue';
                button.disabled = false;
            }
        }

        // Navigation function
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).style.display = 'block';
            document.querySelector(`[onclick="showSection('${sectionName}')"]`).classList.add('active');
            
            // Load section-specific data
            if (sectionName === 'overview') {
                loadDashboardStats();
            } else if (sectionName === 'queue') {
                loadQueue();
            } else if (sectionName === 'current') {
                loadCurrentFeaturedRestaurant();
            }
        }
        
        // Load current featured restaurant for Current Week page
        async function loadCurrentFeaturedRestaurant() {
            try {
                const data = await apiCall('/api/restaurants/current');
                const container = document.getElementById('currentFeaturedRestaurant');
                
                if (data) {
                    const categories = data.categories ? (Array.isArray(data.categories) ? data.categories : JSON.parse(data.categories)) : [];
                    const categoryText = Array.isArray(categories) ? categories.map(c => c.title || c).join(', ') : 'Restaurant';
                    
                    container.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1.5rem; background: #2a2a2a; padding: 1.5rem; border-radius: 12px; border: 2px solid #20b2aa;">
                            <img src="${data.imageUrl || '/placeholder.jpg'}" alt="${data.name}" 
                                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid #444;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #20b2aa; font-size: 1.5rem;">${data.name}</h3>
                                <p style="margin: 0.5rem 0; color: #ccc; font-size: 1.1rem;">${data.address}</p>
                                <p style="margin: 0.5rem 0; color: #888;">${categoryText}</p>
                                <div style="display: flex; gap: 1rem; margin-top: 0.75rem;">
                                    <span style="background: #20b2aa; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold;">
                                        ⭐ ${data.rating || 'N/A'}
                                    </span>
                                    <span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: bold;">
                                        ${data.price || 'N/A'}
                                    </span>
                                    <span style="background: #6c757d; color: white; padding: 0.25rem 0.75rem; border-radius: 20px;">
                                        ${data.reviewCount || 0} reviews
                                    </span>
                                </div>
                                <p style="margin: 0.75rem 0 0 0; color: #20b2aa; font-size: 0.9rem;">
                                    📍 Featured since ${new Date(data.featuredDate || data.createdAt).toLocaleDateString()}
                                </p>
                            </div>
                            <div style="text-align: center;">
                                <div style="background: linear-gradient(135deg, #20b2aa, #17a2b8); color: white; padding: 1rem; border-radius: 50%; margin-bottom: 0.5rem;">
                                    <span style="font-size: 2rem;">🍽️</span>
                                </div>
                                <p style="margin: 0; color: #20b2aa; font-weight: bold;">FEATURED</p>
                                <p style="margin: 0; color: #888; font-size: 0.8rem;">This Week</p>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<p style="color: #888; text-align: center; padding: 2rem;">No restaurant currently featured</p>';
                }
            } catch (error) {
                console.error('Error loading current featured restaurant:', error);
                document.getElementById('currentFeaturedRestaurant').innerHTML = 
                    '<div class="error" style="text-align: center; padding: 2rem; color: #dc3545;">Failed to load current restaurant</div>';
            }
        }

        // Initialize dashboard (removed duplicate - handled above)
    </script>
</body>
</html>
